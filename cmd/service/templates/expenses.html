<!DOCTYPE html>
<html>
  {{template "head"}}
  <body>
    {{template "navbar" .}}
    <div>
      <h1>Expenses</h1>
    </div>
    <div>
      {{ if .HasExpenses }}
      <div style="padding-bottom: 20px">
        {{ template "_upload_expenses_form" }}
      </div>
      <div>
        <div>
          <button
            id="add-expense-button"
            style="margin-bottom: 10px; width: 15%"
            class="btn btn-default f-right"
          >
            Add Expense
          </button>
        </div>
        <table id="expenses-table">
          <thead id="expenses-table-head">
            <tr>
              <th colspan="1">Date</th>
              <th colspan="1">Amount</th>
              <th colspan="1">Category</th>
              <th colspan="1">SubCategory</th>
            </tr>
          </thead>
          <tbody id="expenses-table-body">
            {{range $e := .Expenses}}
            <tr>
              <td>
                <input
                  style="border: 0; outline: 0"
                  type="date"
                  name="date"
                  id="date-{{$e.Date}}"
                  value="{{$e.Date}}"
                />
              </td>
              <td>
                <input
                  style="border: 0; outline: 0"
                  type="number"
                  name="amount"
                  id="amount-{{$e.ID}}"
                  value="{{$e.Amount}}"
                  min="0"
                  placeholder="42,00"
                />
              </td>
              <td>
                <input
                  style="border: 0; outline: 0"
                  type="text"
                  name="category"
                  id="category-{{$e.ID}}"
                  value="{{$e.Category}}"
                />
              </td>
              <td>
                <input
                  style="border: 0; outline: 0"
                  type="text"
                  name="subcategory"
                  id="subcategory-{{$e.ID}}"
                  value="{{$e.Subcategory}}"
                />
              </td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </div>
      {{ else }}
      <div>
        <p>
          You can keep track of your personal finances and analyse trends to
          gather insights through the <a href="/dashboard">Dashboard</a>.
        </p>
        <p>
          In this page you can manage and browse the individual transactions.
          You don't seem to have any expenses saved, would you like to upload
          some?
        </p>
      </div>
      <div>{{ template "_upload_expenses_form" }}</div>
      {{ end }}
    </div>
    <script>
      const throwOnError = (response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response;
      };

      const doRequest = (req) =>
        fetch(req)
          .then(throwOnError)
          .then((res) => res.json());

      const updateExpense = (id, expenseField, value) =>
        doRequest(
          new Request(`/expenses/${id}`, {
            method: "PATCH",
            headers: { Accept: "application/json" },
            body: JSON.stringify({ [expenseField]: value }),
          })
        );

      const createExpense = (date, amount) =>
        doRequest(
          new Request("/expenses", {
            method: "PUT",
            headers: { Accept: "application/json" },
            body: JSON.stringify({ date: date, amount: amount }),
          })
        );

      const addListenersToTableCell = (input) => {
        input.addEventListener("focus", (event) => {
          if (!input.parentElement.classList.contains("cell--selected")) {
            input.parentElement.classList.add("cell--selected");
          }

          if (input.parentElement.classList.contains("cell--pending")) {
            input.parentElement.classList.remove("cell--pending");
          }
        });

        input.addEventListener("focusout", (event) => {
          if (input.parentElement.classList.contains("cell--selected")) {
            input.parentElement.classList.remove("cell--selected");
          }

          const inputIsRequiredAndEmpty =
            (input.value === null || input.value === "") &&
            (input.id.includes("date") || input.id.includes("amount"));

          if (inputIsRequiredAndEmpty) {
            input.parentElement.classList.add("cell--pending");
          }
        });

        input.addEventListener("change", (event) => {
          const [expenseField, expenseId, ts] = input.id.split("-");
          if (expenseId === "new") {
            const amount = document.getElementById(`amount-new-${ts}`).value;
            const date = document.getElementById(`date-new-${ts}`).value;
            if (date && amount) {
              createExpense(date, amount).then(({ id: id }) => {
                // Update the row to contain the ID of the newly created expense.
                document.getElementById(`date-new-${ts}`).id = `date-${id}`;
                document.getElementById(`amount-new-${ts}`).id = `amount-${id}`;
                document.getElementById(
                  `category-new-${ts}`
                ).id = `category-${id}`;
                document.getElementById(
                  `subcategory-new-${ts}`
                ).id = `subcategory-${id}`;
              });
            }
          } else {
            updateExpense(expenseId, expenseField, event.target.value);
          }
        });
      };

      // FIXME: this should just be row inputs.
      const addListenersToTable = () =>
        document.querySelectorAll("input").forEach(addListenersToTableCell);

      const addTableRow = () => {
        // NOTE: Programatically speaking, this is broken... but it's good
        // enough as long as humans use the UI.
        //
        // The reason is that if you click the button within less than a
        // millisecond, two rows with the same ID will be created.
        const timestamp = Date.now();
        const rowHTML = `
              <td class="cell--pending">
                <input
                  style="border: 0; outline: 0"
                  type="date"
                  name="date"
                  id="date-new-${timestamp}"
                />
              </td>
              <td class="cell--pending">
                <input
                  style="border: 0; outline: 0"
                  type="number"
                  name="amount"
                  id="amount-new-${timestamp}"
                  min="0"
                  placeholder="42,00"
                />
              </td>
              <td>
                <input
                  style="border: 0; outline: 0"
                  type="text"
                  name="category"
                  id="category-new-${timestamp}"
                />
              </td>
              <td>
                <input
                  style="border: 0; outline: 0"
                  type="text"
                  name="subcategory"
                  id="subcategory-new-${timestamp}"
                />
              </td>
        `;
        const rowNode = document.createElement("tr");
        rowNode.innerHTML = rowHTML;

        const table = document.getElementById("expenses-table-body");
        table.prepend(rowNode);

        addListenersToTableCell(
          document.getElementById(`date-new-${timestamp}`)
        );
        addListenersToTableCell(
          document.getElementById(`amount-new-${timestamp}`)
        );
        addListenersToTableCell(
          document.getElementById(`category-new-${timestamp}`)
        );
        addListenersToTableCell(
          document.getElementById(`subcategory-new-${timestamp}`)
        );
      };

      const addListenersToButtons = () =>
        document
          .getElementById("add-expense-button")
          .addEventListener("click", addTableRow);

      addListenersToTable();

      addListenersToButtons();
    </script>
  </body>
</html>
